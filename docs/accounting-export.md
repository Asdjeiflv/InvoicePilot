# 会計連携 CSV エクスポート仕様

## 概要
InvoicePilot の請求書・入金データを会計ソフト（freee、マネーフォワード）に取り込むための CSV エクスポート機能の仕様書です。

## サポート会計ソフト

### 1. freee（フリー）
- **対応バージョン**: 最新版
- **取込方式**: 仕訳帳インポート
- **エンドポイント**: `GET /accounting/export/freee`

### 2. マネーフォワード クラウド会計
- **対応バージョン**: 最新版
- **取込方式**: 仕訳帳インポート
- **エンドポイント**: `GET /accounting/export/moneyforward`

## エクスポート形式

### リクエストパラメータ

| パラメータ | 型 | 必須 | 説明 | 例 |
|----------|-----|------|------|-----|
| `start_date` | date | ✅ | 開始日（YYYY-MM-DD） | 2026-01-01 |
| `end_date` | date | ✅ | 終了日（YYYY-MM-DD） | 2026-01-31 |
| `type` | string | ✅ | invoices または payments | invoices |

### 使用例

#### freee 形式でエクスポート
```
GET /accounting/export/freee?start_date=2026-01-01&end_date=2026-01-31&type=invoices
```

#### マネーフォワード形式でエクスポート
```
GET /accounting/export/moneyforward?start_date=2026-01-01&end_date=2026-01-31&type=payments
```

## CSV フォーマット

### freee 形式（請求書）

| カラム | 説明 | 例 |
|--------|------|-----|
| 取引日 | 請求書発行日 | 2026/01/15 |
| 借方勘定科目 | 売掛金（固定） | 売掛金 |
| 借方補助科目 | 顧客名 | 株式会社サンプル |
| 借方部門 | 部門名（空欄） | |
| 借方金額(税込) | 請求金額（税込） | 110000 |
| 借方税区分 | 税区分 | 課税売上10% |
| 貸方勘定科目 | 売上高（固定） | 売上高 |
| 貸方補助科目 | 空欄 | |
| 貸方部門 | 部門名（空欄） | |
| 貸方金額(税込) | 売上金額（税抜） | 100000 |
| 貸方税区分 | 税区分 | 課税売上10% |
| 摘要 | 請求書番号 | 請求書 I-2026-00001 |
| タグ | InvoicePilot（固定） | InvoicePilot |

#### サンプル CSV

```csv
取引日,借方勘定科目,借方補助科目,借方部門,借方金額(税込),借方税区分,貸方勘定科目,貸方補助科目,貸方部門,貸方金額(税込),貸方税区分,摘要,タグ
2026/01/15,売掛金,株式会社サンプル,,110000,課税売上10%,売上高,,,100000,課税売上10%,請求書 I-2026-00001,InvoicePilot
2026/01/20,売掛金,合同会社テスト,,55000,課税売上10%,売上高,,,50000,課税売上10%,請求書 I-2026-00002,InvoicePilot
```

### freee 形式（入金）

| カラム | 説明 | 例 |
|--------|------|-----|
| 取引日 | 入金日 | 2026/01/25 |
| 借方勘定科目 | 普通預金（固定） | 普通預金 |
| 借方補助科目 | 空欄 | |
| 借方部門 | 部門名（空欄） | |
| 借方金額(税込) | 入金額 | 110000 |
| 借方税区分 | 対象外（固定） | 対象外 |
| 貸方勘定科目 | 売掛金（固定） | 売掛金 |
| 貸方補助科目 | 顧客名 | 株式会社サンプル |
| 貸方部門 | 部門名（空欄） | |
| 貸方金額(税込) | 入金額 | 110000 |
| 貸方税区分 | 対象外（固定） | 対象外 |
| 摘要 | 請求書番号 | 入金 I-2026-00001 |
| タグ | InvoicePilot（固定） | InvoicePilot |

#### サンプル CSV

```csv
取引日,借方勘定科目,借方補助科目,借方部門,借方金額(税込),借方税区分,貸方勘定科目,貸方補助科目,貸方部門,貸方金額(税込),貸方税区分,摘要,タグ
2026/01/25,普通預金,,,110000,対象外,売掛金,株式会社サンプル,,110000,対象外,入金 I-2026-00001,InvoicePilot
```

### マネーフォワード形式（請求書）

| カラム | 説明 | 例 |
|--------|------|-----|
| 取引日 | 請求書発行日 | 2026-01-15 |
| 借方勘定科目 | 売掛金（固定） | 売掛金 |
| 借方補助科目 | 顧客名 | 株式会社サンプル |
| 借方金額 | 請求金額（税込） | 110000 |
| 借方税区分 | 税区分 | 課税売上10% |
| 貸方勘定科目 | 売上高（固定） | 売上高 |
| 貸方補助科目 | 空欄 | |
| 貸方金額 | 売上金額（税抜） | 100000 |
| 貸方税区分 | 税区分 | 課税売上10% |
| 摘要 | 請求書番号 | 請求書 I-2026-00001 |
| メモタグ | InvoicePilot（固定） | InvoicePilot |

#### サンプル CSV

```csv
取引日,借方勘定科目,借方補助科目,借方金額,借方税区分,貸方勘定科目,貸方補助科目,貸方金額,貸方税区分,摘要,メモタグ
2026-01-15,売掛金,株式会社サンプル,110000,課税売上10%,売上高,,100000,課税売上10%,請求書 I-2026-00001,InvoicePilot
```

## 勘定科目マッピング

### 請求書発行時

| 項目 | 借方 | 貸方 |
|------|------|------|
| 勘定科目 | 売掛金 | 売上高 |
| 補助科目 | 顧客名 | - |
| 金額 | 税込金額 | 税抜金額 |
| 税区分 | 課税売上10% | 課税売上10% |

### 入金記録時

| 項目 | 借方 | 貸方 |
|------|------|------|
| 勘定科目 | 普通預金 | 売掛金 |
| 補助科目 | - | 顧客名 |
| 金額 | 入金額 | 入金額 |
| 税区分 | 対象外 | 対象外 |

## 税区分について

現在サポートしている税区分：
- **課税売上10%**: 標準税率（消費税10%）
- **対象外**: 入金など消費税の対象外取引

### 今後の拡張予定
- 軽減税率8%（食品等）
- 非課税
- 免税
- 不課税

## freee への取込手順

1. InvoicePilot で CSV エクスポート
   ```
   GET /accounting/export/freee?start_date=2026-01-01&end_date=2026-01-31&type=invoices
   ```

2. freee にログイン
   - https://secure.freee.co.jp/

3. **取引 > 仕訳帳** に移動

4. **インポート** ボタンをクリック

5. ダウンロードした CSV ファイルを選択

6. **取込実行** をクリック

7. 確認画面で内容を確認し、**登録** をクリック

## マネーフォワードへの取込手順

1. InvoicePilot で CSV エクスポート
   ```
   GET /accounting/export/moneyforward?start_date=2026-01-01&end_date=2026-01-31&type=invoices
   ```

2. マネーフォワード クラウド会計にログイン
   - https://biz.moneyforward.com/

3. **会計帳簿 > 仕訳帳** に移動

4. **インポート** ボタンをクリック

5. **仕訳帳** を選択

6. ダウンロードした CSV ファイルを選択

7. **インポート実行** をクリック

8. 確認画面で内容を確認し、**登録** をクリック

## エラー対処

### エラー: 「勘定科目が見つかりません」

**原因**: freee/マネーフォワード側で勘定科目が登録されていない

**対処**:
1. 会計ソフトの **設定 > 勘定科目** を開く
2. 以下の勘定科目を追加:
   - 売掛金（資産）
   - 売上高（収益）
   - 普通預金（資産）

### エラー: 「税区分が不正です」

**原因**: 税区分の名称が会計ソフトと一致していない

**対処**:
1. CSV の税区分を会計ソフトの税区分名に合わせて編集
2. 一般的な税区分名:
   - freee: 「課税売上10%」
   - マネーフォワード: 「課税売上10%」

### エラー: 「補助科目が見つかりません」

**原因**: 顧客名が補助科目として登録されていない

**対処**:
1. **設定 > 補助科目** を開く
2. 売掛金の補助科目として顧客を登録
3. または CSV の補助科目列を空欄にして、手動で設定

## カスタマイズ

### 部門を追加したい場合

`AccountingExportController.php` の該当部分を編集：

```php
// 借方部門を設定
'', // 借方部門 → '営業部' に変更

// 貸方部門を設定
'', // 貸方部門 → '営業部' に変更
```

### 税区分を変更したい場合

```php
'課税売上10%', // 借方税区分 → '軽減税率8%' に変更
```

### 勘定科目を変更したい場合

```php
'売掛金', // 借方勘定科目 → '未収入金' に変更
'売上高', // 貸方勘定科目 → 'サービス売上' に変更
```

## 権限設定

会計連携エクスポートは以下のロールで利用可能：
- ✅ admin
- ✅ accounting
- ❌ sales（閲覧のみ）
- ❌ auditor（閲覧のみ）

## 注意事項

1. **draft、canceled の請求書は除外**: 確定済みの請求書のみエクスポート
2. **UTF-8 BOM 付き**: Excel で正しく文字コードを認識
3. **日付形式**: freee は `YYYY/MM/DD`、マネーフォワードは `YYYY-MM-DD`
4. **カンマ・改行のエスケープ**: 摘要に特殊文字が含まれる場合は自動エスケープ

## サポート

エラーが発生した場合は、以下を確認してください：
- CSV ファイルが UTF-8 エンコードであること
- 会計ソフト側で勘定科目・税区分が登録されていること
- 期間指定が正しいこと（start_date ≤ end_date）

---

最終更新: 2026-02-11  
次回レビュー予定: 2026-03-11
